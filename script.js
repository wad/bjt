document.addEventListener('DOMContentLoaded', () => {

    const dealerCardDiv = document.getElementById('dealer-card');
    const dealerCardTextDiv = document.getElementById('dealer-card-text');
    const playerCard1Div = document.getElementById('player-card-1');
    const playerCard1TextDiv = document.getElementById('player-card-1-text');
    const playerCard2Div = document.getElementById('player-card-2');
    const playerCard2TextDiv = document.getElementById('player-card-2-text');
    const resultPendingDiv = document.getElementById('resultPending');
    const resultSuccessDiv = document.getElementById('resultSuccess');
    const resultCloseDiv = document.getElementById('resultClose');
    const resultFailureDiv = document.getElementById('resultFailure');
    const scoreDiv = document.getElementById('score');
    const tableDiv = document.getElementById('table');
    const tableKeyDiv = document.getElementById('tableKey');
    const decksSelect = document.getElementById('decks');
    const soft17Select = document.getElementById('soft17');
    const surrenderPermittedCheckbox = document.getElementById('surrenderPermitted');
    const dasPermittedCheckbox = document.getElementById('doubleAfterSplitPermitted');
    const hardModeCheckbox = document.getElementById('hardMode');
    const reverseTableCheckbox = document.getElementById('reverseTable');

    const doubleButton = document.getElementById('buttonDouble');
    const doubleHitButton = document.getElementById('buttonDoubleHit');
    const doubleStandButton = document.getElementById('buttonDoubleStand');
    const splitButton = document.getElementById('buttonSplit');
    const splitHitButton = document.getElementById('buttonSplitHit');
    const splitStandButton = document.getElementById('buttonSplitStand');
    const splitDoubleHitButton = document.getElementById('buttonSplitDoubleHit');

    const surrenderButton = document.getElementById('buttonSurrender');
    const surrenderHitButton = document.getElementById('buttonSurrenderHit');
    const surrenderStandButton = document.getElementById('buttonSurrenderStand');
    const surrenderSplitButton = document.getElementById('buttonSurrenderSplit');

    const suites = ['S', 'H', 'D', 'C'];
    const cards = ['2', '3', '4', '5', '6', '7', '8', '9', 'X', 'A'];
    const cardsValuedTen = ['10', 'J', 'Q', 'K'];

    const cardIndexes = {
        '2': 0,
        '3': 1,
        '4': 2,
        '5': 3,
        '6': 4,
        '7': 5,
        '8': 6,
        '9': 7,
        'X': 8,
        '10': 8,
        'J': 8,
        'Q': 8,
        'K': 8,
        'A': 9
    };

    const actionCodesByAction = {
        'buttonHit': 'H ',
        'buttonStand': 'S ',
        'buttonDouble': 'D ',
        'buttonDoubleHit': 'Dh',
        'buttonDoubleStand': 'Ds',
        'buttonSplit': 'P ',
        'buttonSplitHit': 'Ph',
        'buttonSplitStand': 'Ps',
        'buttonSplitDoubleHit': 'Pd',
        'buttonSurrender': 'U ',
        'buttonSurrenderHit': 'Uh',
        'buttonSurrenderStand': 'Us',
        'buttonSurrenderSplit': 'Up'
    };

    const actionNamesByActionCode = {
        'H ': 'Hit',
        'S ': 'Stand',
        'D ': 'Double down',
        'Dh': 'Double down (or hit)',
        'Ds': 'Double down (or stand)',
        'P ': 'Split',
        'Ph': 'Split (or hit)',
        'Ps': 'Split (or stand)',
        'Pd': 'Split (or double down (or hit))',
        'U ': 'Surrender',
        'Uh': 'Surrender (or hit)',
        'Us': 'Surrender (or stand)',
        'Up': 'Surrender (or split)'
    };

    const actionCodeIsForHardMode = {
        'H ': true,
        'S ': true,
        'D ': false,
        'Dh': true,
        'Ds': true,
        'P ': false,
        'Ph': true,
        'Ps': true,
        'Pd': true,
        'U ': false,
        'Uh': true,
        'Us': true,
        'Up': true
    };

    const actionCodeIsForNonHardMode = {
        'H ': true,
        'S ': true,
        'D ': true,
        'Dh': false,
        'Ds': false,
        'P ': true,
        'Ph': false,
        'Ps': false,
        'Pd': false,
        'U ': true,
        'Uh': false,
        'Us': false,
        'Up': false
    };

    const charsPerActionCode = 2;
    const actionCodeColors = {
        'H ': '#28b463',
        'S ': '#e74c3c',
        'D ': '#85c1e9',
        'Dh': '#85c1e9',
        'Ds': '#5dade2',
        'P ': '#f9e79f',
        'Ph': '#f9e79f',
        'Ps': '#f4d03f',
        'Pd': '#d4ac0d',
        'U ': '#e5e7e9',
        'Uh': '#e5e7e9',
        'Us': '#bdc3c7',
        'Up': '#85929e'
    };

    const numCharsInSegment = charsPerActionCode * cards.length;
    const segLen = numCharsInSegment + 2;
    const correctPlaySegmentOffsets = {
        '4HUDa': 0, '4HUda': segLen, '4HuDa': 2 * segLen, '4Huda': 3 * segLen,
        '4hUDa': 4 * segLen, '4hUda': 5 * segLen, '4huDa': 6 * segLen, '4huda': 7 * segLen,
        '2HuDa': 8 * segLen, '2Huda': 9 * segLen, '2huDa': 10 * segLen, '2huda': 11 * segLen,
        '1HuDa': 12 * segLen, '1Huda': 13 * segLen, '1huDa': 14 * segLen, '1huda': 15 * segLen,
        '4HUDA': 16 * segLen, '4HUdA': 17 * segLen, '4HuDA': 18 * segLen, '4HudA': 19 * segLen,
        '4hUDA': 20 * segLen, '4hUdA': 21 * segLen, '4huDA': 22 * segLen, '4hudA': 23 * segLen,
        '2HuDA': 24 * segLen, '2HudA': 25 * segLen, '2huDA': 26 * segLen, '2hudA': 27 * segLen,
        '1HuDA': 28 * segLen, '1HudA': 29 * segLen, '1huDA': 30 * segLen, '1hudA': 31 * segLen
    };

    // The keys of this object are the two player cards, standardized, in ascending value order.
    // Each two characters in the associated strings corresponds to an action code, "--", or "..".
    // The position of these two-character codes indicates the associated dealer card, within each segment.
    // A segment of 10 of these action codes, separated by "--", are here for different options.
    // The value "--" is ignored, it's just to make it easier to work with the table, separating segments.
    // The value ".." (two dots) means "use the default correct play".
    // The default correct play is the first segment, the leftmost 20 characters of each string,
    // corresponding to options: 4 or more decks, H17, surrender is available, double after split is available.
    const correctPlays = {
        //     468,H17,SUR,DS,a      468,H17,SUR,nDS,a     468,H17,nSUR,DS,a     468,H17,nSUR,nDS,a    468,S17,SUR,DS,a      468,S17,SUR,nDS,a     468,S17,nSUR,DS,a     468,S17,nSUR,nDS,a    2,H17,nSUR,DS,a       2,H17,nSUR,nDS,a      2,S17,nSUR,DS,a       2,S17,nSUR,nDS,a      1,H17,nSUR,DS,a       1,H17,nSUR,nDS,a      1,S17,nSUR,DS,a       1,S17,nSUR,nDS,a      468,H17,SUR,DS,A      468,H17,SUR,nDS,A     468,H17,nSUR,DS,A     468,H17,nSUR,nDS,A    468,S17,SUR,DS,A      468,S17,SUR,nDS,A     468,S17,nSUR,DS,A     468,S17,nSUR,nDS,A    2,H17,nSUR,DS,A       2,H17,nSUR,nDS,A      2,S17,nSUR,DS,A       2,S17,nSUR,nDS,A      1,H17,nSUR,DS,A       1,H17,nSUR,nDS,A      1,S17,nSUR,DS,A       1,S17,nSUR,nDS,A
        //     2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A
        '22': 'PhPhPhPhPhPhH H H H --H H ................--....................--H H ................--....................--H H ................--....................22H H ................--....................--H ..................--....................--H ..................22....................--H ..................--....................--H ..................22....................04H H ................--....................--H H ................--....................22H H ................--....................--H H ................--....................22H ..................--....................--H ..................--....................22H ..................--....................--H ..................',
        '23': 'H H H H H H H H H H --....................--....................--....................--....................--....................--....................23....................--....................--....................--....................--....................23....................--....................--....................--....................23....................05....................--....................--....................--....................23....................--....................--....................--....................23....................--....................--....................--....................23....................--....................--....................',
        '24': 'H H H H H H H H H H --....................--....................--....................--....................--....................--....................24....................--....................--....................--....................--....................24....................--....................--....................--....................24....................06....................--....................--....................--....................24....................--....................--....................--....................24....................--....................--....................--....................24....................--....................--....................',
        '25': 'H H H H H H H H H H --....................--....................--....................--....................--....................--....................25....................--....................--....................--....................--....................25....................--....................--....................--....................25....................07....................--....................--....................--....................25....................--....................--....................--....................25....................--....................--....................--....................25....................--....................--....................',
        '26': 'H H H H H H H H H H --....................--....................--....................--....................--....................--....................26....................--....................--....................--....................--....................26......DhDh..........--......DhDh..........--......DhDh..........--......DhDh..........26......DhDh..........08....................--....................--....................--....................26....................--....................--....................--....................26....................--....................--....................--......DhDh..........26......DhDh..........--......DhDh..........--......DhDh..........',
        '27': 'H DhDhDhDhH H H H H --....................--....................--....................--....................--....................--....................27....................--Dh..................--Dh..................--Dh..................--Dh..................27Dh..................--Dh..................--Dh..................--Dh..................27Dh........Dh........09....................--....................--....................--....................27....................--....................--....................--Dh..................27Dh..................--Dh..................--Dh..................--Dh..................27Dh..................--Dh..................--Dh..................',
        '28': 'DhDhDhDhDhDhDhDhH H --....................--....................--....................--....................--....................--....................28....................--....................--....................--....................--....................28....................--....................--....................--....................28................DhDh10....................--....................--....................--....................28....................--....................--....................--....................28....................--....................--....................--....................28....................--....................--....................',
        '29': 'DhDhDhDhDhDhDhDhDhDh--....................--....................--....................--..................H --..................H --..................H 29..................H --....................--....................--....................--....................29....................--....................--....................--....................29..................Dh11....................--....................--....................--..................H 29..................H --..................H --..................H --....................29....................--....................--....................--....................29....................--....................--....................',
        '2X': 'H H S S S H H H H H --....................--....................--....................--....................--....................--....................2X....................--....................--....................--....................--....................2X....................--....................--....................--....................2XS S S ..............12....................--....................--....................--....................2X....................--....................--....................--....................2X....................--....................--....................--....................2X....................--....................--....................',
        '2A': 'H H H DhDhH H H H H --....................--....................--....................--....................--....................--....................2A....................--....................--....................--....................--....................2A....H ..............--....H ..............--....H ..............--....H ..............2A....................--....................--....................--....................--....................2A....................--....................--....................--....................2A....................--....................--....................--....H ..............2A....H ..............--....H ..............--....H ..............',
        '33': 'PhPhPhPhPhPhH H H H --H H ................--....................--H H ................--....................--H H ................--....................33H H ................--....................--H H ................--....................--H H ................33....................--H H ................--....................--H H ................33....................06H H ................--....................--H H ................--....................33H H ................--....................--H H ................--....................33H H ................--....................--H H ................--....................33H H ................--....................--H H ................',
        '34': 'H H H H H H H H H H --....................--....................--....................--....................--....................--....................34....................--....................--....................--....................--....................34....................--....................--....................--....................34....................07....................--....................--....................--....................34....................--....................--....................--....................34....................--....................--....................--....................34....................--....................--....................',
        '35': 'H H H H H H H H H H --....................--....................--....................--....................--....................--....................35....................--....................--....................--....................--....................35......DhDh..........--......DhDh..........--......DhDh..........--......DhDh..........35......DhDh..........08....................--....................--....................--....................35....................--....................--....................--....................35....................--....................--....................--......DhDh..........35......DhDh..........--......DhDh..........--......DhDh..........',
        '36': 'H DhDhDhDhH H H H H --....................--....................--....................--....................--....................--....................36....................--Dh..................--Dh..................--Dh..................--Dh..................36Dh..................--Dh..................--Dh..................--Dh..................36Dh........Dh........09....................--....................--....................--....................36....................--....................--....................--Dh..................36Dh..................--Dh..................--Dh..................--Dh..................36Dh..................--Dh..................--Dh..................',
        '37': 'DhDhDhDhDhDhDhDhH H --....................--....................--....................--....................--....................--....................37....................--....................--....................--....................--....................37....................--....................--....................--....................37................DhDh10....................--....................--....................--....................37....................--....................--....................--....................37....................--....................--....................--....................37....................--....................--....................',
        '38': 'DhDhDhDhDhDhDhDhDhDh--....................--....................--....................--..................H --..................H --..................H 38..................H --....................--....................--....................--....................38....................--....................--....................--....................38..................Dh11....................--....................--....................--..................H 38..................H --..................H --..................H --....................38....................--....................--....................--....................38....................--....................--....................',
        '39': 'H H S S S H H H H H --....................--....................--....................--....................--....................--....................39....................--....................--....................--....................--....................39....................--....................--....................--....................39S S S ..............12....................--....................--....................--....................39....................--....................--....................--....................39....................--....................--....................--....................39....................--....................--....................',
        '3X': 'S S S S S H H H H H --....................--....................--....................--....................--....................--....................3X....................--....................--....................--....................--....................3X....................--....................--....................--....................3X....................13....................--....................--....................--....................3X....................--....................--....................--....................3X....................--....................--....................--....................3X....................--....................--....................',
        '3A': 'H H H DhDhH H H H H --....................--....................--....................--....................--....................--....................3A....................--....Dh..............--....Dh..............--....................--....................3A....H ..............--....H ..............--....H ..............--....H ..............3A....................--....................--....................--....................--....................3A....................--....................--....................--....Dh..............3A....Dh..............--....................--....................--....H ..............3A....H ..............--....H ..............--....H ..............',
        '44': 'H H H PhPhH H H H H --......H H ..........--....................--......H H ..........--....................--......H H ..........--....................44......H H ..........--....................--......H H ..........--....................--......H H ..........44......PdPd..........--......H H ..........--......PdPd..........--......H H ..........44......DhDh..........08......H H ..........--....................--......H H ..........--....................44......H H ..........--....................--......H H ..........--....................44......H H ..........--....................--......H H ..........--......PdPd..........44......H H ..........--......PdPd..........--......H H ..........',
        '45': 'H DhDhDhDhH H H H H --....................--....................--....................--....................--....................--....................45....................--Dh..................--Dh..................--Dh..................--Dh..................45Dh..................--Dh..................--Dh..................--Dh..................45Dh........Dh........09....................--....................--....................--....................45....................--....................--....................--Dh..................45Dh..................--Dh..................--Dh..................--Dh..................45Dh..................--Dh..................--Dh..................',
        '46': 'DhDhDhDhDhDhDhDhH H --....................--....................--....................--....................--....................--....................46....................--....................--....................--....................--....................46....................--....................--....................--....................46................DhDh10....................--....................--....................--....................46....................--....................--....................--....................46....................--....................--....................--....................46....................--....................--....................',
        '47': 'DhDhDhDhDhDhDhDhDhDh--....................--....................--....................--..................H --..................H --..................H 47..................H --....................--....................--....................--....................47....................--....................--....................--....................47..................Dh11....................--....................--....................--..................H 47..................H --..................H --..................H --....................47....................--....................--....................--....................47....................--....................--....................',
        '48': 'H H S S S H H H H H --....................--....................--....................--....................--....................--....................48....................--....................--....................--....................--....................48....................--....................--....................--....................48S S S ..............12....................--....................--....................--....................48....................--....................--....................--....................48....................--....................--....................--....................48....................--....................--....................',
        '49': 'S S S S S H H H H H --....................--....................--....................--....................--....................--....................49....................--....................--....................--....................--....................49....................--....................--....................--....................49....................13....................--....................--....................--....................49....................--....................--....................--....................49....................--....................--....................--....................49....................--....................--....................',
        '4X': 'S S S S S H H H H H --....................--....................--....................--....................--....................--....................4X....................--....................--....................--....................--....................4X....................--....................--....................--....................4X................Uh..14....................--....................--....................--....................4X....................--....................--....................--....................4X....................--....................--....................--....................4X....................--....................--....................',
        '4A': 'H H DhDhDhH H H H H --....................--....................--....................--....................--....................--....................4A....................--....................--....................--....................--....................4A....................--....................--....................--....................4A....................--....................--....................--....................--....................4A....................--....................--....................--....................4A....................--....................--....................--....................4A....................--....................--....................',
        //     468,H17,SUR,DS,a      468,H17,SUR,nDS,a     468,H17,nSUR,DS,a     468,H17,nSUR,nDS,a    468,S17,SUR,DS,a      468,S17,SUR,nDS,a     468,S17,nSUR,DS,a     468,S17,nSUR,nDS,a    2,H17,nSUR,DS,a       2,H17,nSUR,nDS,a      2,S17,nSUR,DS,a       2,S17,nSUR,nDS,a      1,H17,nSUR,DS,a       1,H17,nSUR,nDS,a      1,S17,nSUR,DS,a       1,S17,nSUR,nDS,a      468,H17,SUR,DS,A      468,H17,SUR,nDS,A     468,H17,nSUR,DS,A     468,H17,nSUR,nDS,A    468,S17,SUR,DS,A      468,S17,SUR,nDS,A     468,S17,nSUR,DS,A     468,S17,nSUR,nDS,A    2,H17,nSUR,DS,A       2,H17,nSUR,nDS,A      2,S17,nSUR,DS,A       2,S17,nSUR,nDS,A      1,H17,nSUR,DS,A       1,H17,nSUR,nDS,A      1,S17,nSUR,DS,A       1,S17,nSUR,nDS,A
        //     2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A   2 3 4 5 6 7 8 9 X A
        '55': 'DhDhDhDhDhDhDhDhH H --....................--....................--....................--....................--....................--....................55....................--....................--....................--....................--....................55....................--....................--....................--....................55................DhDh10....................--....................--....................--....................55....................--....................--....................--....................55....................--....................--....................--....................55....................--....................--....................',
        '56': 'DhDhDhDhDhDhDhDhDhDh--....................--....................--....................--..................H --..................H --..................H 56..................H --....................--....................--....................--....................56....................--....................--....................--....................56..................Dh11....................--....................--....................--..................H 56..................H --..................H --..................H --....................56....................--....................--....................--....................56....................--....................--....................',
        '57': 'H H S S S H H H H H --....................--....................--....................--....................--....................--....................57....................--....................--....................--....................--....................57....................--....................--....................--....................57S S S ..............12....................--....................--....................--....................57....................--....................--....................--....................57....................--....................--....................--....................57....................--....................--....................',
        '58': 'S S S S S H H H H H --....................--....................--....................--....................--....................--....................58....................--....................--....................--....................--....................58....................--....................--....................--....................58....................13....................--....................--....................--....................58....................--....................--....................--....................58....................--....................--....................--....................58....................--....................--....................',
        '59': 'S S S S S H H H H H --....................--....................--....................--....................--....................--....................59....................--....................--....................--....................--....................59....................--....................--....................--....................59................Uh..14....................--....................--....................--....................59....................--....................--....................--....................59....................--....................--....................--....................59....................--....................--....................',
        '5X': 'S S S S S H H H UhUh--....................--................H H --................H H --..................H --..................H --................H H 5X................H H --................H H --................H H --................H H --................H H 5X................H H --................H H --................H H --................H H 5X..............UhS Uh15....................--................H H --................H H --..................H 5X..................H --................H H --................H H --................H H 5X................H H --................H H --................H H --................H H 5X................H H --................H H --................H H ',
        '5A': 'H H DhDhDhH H H H H --....................--....................--....................--....................--....................--....................5A....................--....................--....................--....................--....................5A....................--....................--....................--....................5A....................--....................--....................--....................--....................5A....................--....................--....................--....................5A....................--....................--....................--....................5A....................--....................--....................',
        '66': 'PhPhPsPsPsH H H H H --H ..................--....................--H ..................--....................--H ..................--....................66H ..................--....................--....................--....................--....................66....................--....................--....................--....................66PsPsPs..............12H ..................--....................--H ..................--....................66H ..................--....................--H ..................--....................66....................--....................--....................--....................66....................--....................--....................',
        '67': 'S S S S S H H H H H --....................--....................--....................--....................--....................--....................67....................--....................--....................--....................--....................67....................--....................--....................--....................67....................13....................--....................--....................--....................67....................--....................--....................--....................67....................--....................--....................--....................67....................--....................--....................',
        '68': 'S S S S S H H H H H --....................--....................--....................--....................--....................--....................68....................--....................--....................--....................--....................68....................--....................--....................--....................68................Uh..14....................--....................--....................--....................68....................--....................--....................--....................68....................--....................--....................--....................68....................--....................--....................',
        '69': 'S S S S S H H H UhUh--....................--................H H --................H H --..................H --..................H --................H H 69................H H --................H H --................H H --................H H --................H H 69................H H --................H H --................H H --................H H 69..............UhS Uh15....................--................H H --................H H --..................H 69..................H --................H H --................H H --................H H 69................H H --................H H --................H H --................H H 69................H H --................H H --................H H ',
        '6X': 'S S S S S H H UhUhUh--....................--..............H H H --..............H H H --....................--....................--..............H H H 6X..............H H H --..............H H H --..............H H H --..............H H H --..............H H H 6X..............H H H --..............H H H --..............H H H --..............H H H 6X................S ..16....................--..............H H H --..............H H H --....................6X....................--..............H H H --..............H H H --..............H H H 6X..............H H H --..............H H H --..............H H H --..............H H H 6X..............H H H --..............H H H --..............H H H ',
        '6A': 'H DhDhDhDhH H H H H --....................--....................--....................--....................--....................--....................6A....................--....................--....................--....................--....................6ADh..................--Dh..................--Dh..................--Dh..................6A....................--....................--....................--....................--....................6A....................--....................--....................--....................6A....................--....................--....................--Dh..................6ADh..................--Dh..................--Dh..................',
        '77': 'PsPsPsPsPsPhH H H H --....................--....................--....................--....................--....................--....................77....................--....................--....................--....................--....................77....................--....................--....................--....................77................Uh..14....................--....................--....................--....................77....................--....................--....................--....................77....................--....................--....................--....................77....................--....................--....................',
        '78': 'S S S S S H H H UhUh--....................--................H H --................H H --..................H --..................H --................H H 78................H H --................H H --................H H --................H H --................H H 78................H H --................H H --................H H --................H H 78..............UhS Uh15....................--................H H --................H H --..................H 78..................H --................H H --................H H --................H H 78................H H --................H H --................H H --................H H 78................H H --................H H --................H H ',
        '79': 'S S S S S H H UhUhUh--....................--..............H H H --..............H H H --....................--....................--..............H H H 79..............H H H --..............H H H --..............H H H --..............H H H --..............H H H 79..............H H H --..............H H H --..............H H H --..............H H H 79................S ..16....................--..............H H H --..............H H H --....................79....................--..............H H H --..............H H H --..............H H H 79..............H H H --..............H H H --..............H H H --..............H H H 79..............H H H --..............H H H --..............H H H ',
        '7X': 'S S S S S S S S S Us--....................--..................S --..................S --..................S --..................S --..................S 7X..................S --..................S --..................S --..................S --..................S 7X..................S --..................S --..................S --..................S 7X....................17....................--..................S --..................S --..................S 7X..................S --..................S --..................S --..................S 7X..................S --..................S --..................S --..................S 7X..................S --..................S --..................S ',
        '7A': 'DsDsDsDsDsS S H H H --....................--....................--....................--S ..................--S ..................--S ..................7AS ..................--....................--....................--S ..................--S ..................7AS ..................--S ..................--S ................S --S ................S 7A....................--....................--....................--....................--S ..................7AS ..................--S ..................--S ..................--....................7A....................--S ..................--S ..................--S ..................7AS ..................--S ................S --S ................S ',
        '88': 'PsPsPsPsPsPhPhPhPhUp--....................--..................Ph--..................Ph--..................Ph--..................Ph--..................Ps88..................Ps--..................Ph--..................Ph--..................Ph--..................Ph88..................Ph--..................Ph--..................Ph--..................Ph88................Up..16....................--..................Ph--..................Ph--..................Ph88..................Ph--..................Ps--..................Ps--..................Ph88..................Ph--..................Ph--..................Ph--..................Ph88..................Ph--..................Ph--..................Ph',
        '89': 'S S S S S S S S S Us--....................--..................S --..................S --..................S --..................S --..................S 89..................S --..................S --..................S --..................S --..................S 89..................S --..................S --..................S --..................S 89....................17....................--..................S --..................S --..................S 89..................S --..................S --..................S --..................S 89..................S --..................S --..................S --..................S 89..................S --..................S --..................S ',
        '8X': 'S S S S S S S S S S --....................--....................--....................--....................--....................--....................8X....................--....................--....................--....................--....................8X....................--....................--....................--....................8X....................18....................--....................--....................--....................8X....................--....................--....................--....................8X....................--....................--....................--....................8X....................--....................--....................',
        '8A': 'S S S S DsS S S S S --....................--....................--....................--........S ..........--........S ..........--........S ..........8A........S ..........--....................--....................--........S ..........--........S ..........8A....................--....................--....................--....................8A......DsDs..........--....................--....................--....................--........S ..........8A........S ..........--........S ..........--........S ..........--....................8A....................--........S ..........--........S ..........--....................8A....................--....................--....................',
        '99': 'PsPsPsPsPsS PsPsS S --....................--....................--....................--....................--....................--....................99....................--....................--....................--....................--....................99....................--....................--....................--....................99....................18....................--....................--....................--....................99....................--....................--....................--....................99....................--....................--....................--....................99....................--....................--....................',
        '9X': 'S S S S S S S S S S --....................--....................--....................--....................--....................--....................9X....................--....................--....................--....................--....................9X....................--....................--....................--....................9X....................19....................--....................--....................--....................9X....................--....................--....................--....................9X....................--....................--....................--....................9X....................--....................--....................',
        '9A': 'S S S S S S S S S S --....................--....................--....................--....................--....................--....................9A....................--....................--....................--....................--....................9A....................--....................--....................--....................9A....................--....................--....................--....................--....................9A....................--....................--....................--....................9A....................--....................--....................--....................9A....................--....................--....................',
        'XX': 'S S S S S S S S S S --....................--....................--....................--....................--....................--....................XX....................--....................--....................--....................--....................XX....................--....................--....................--....................XX....................20....................--....................--....................--....................XX....................--....................--....................--....................XX....................--....................--....................--....................XX....................--....................--....................',
        'AA': 'PhPhPsPsPdPhPhPhPhPh--....................--....................--....................--....................--....................--....................AA....................--....................--....................--....................--....................AA....................--....................--....................--....................AA...................--....................--....................--....................--....................-AA...................--....................--....................--....................-AA...................--....................--....................--....................-AA...................--....................--...................-'
    };

    // The position in each string corresponds to the dealer card.
    // The value of each number in each string corresponds to the probability that
    // this card combination will be presented.
    // The '@' symbol means it has a 1/2 chance of being included in the selection.
    // The '#' symbol means it has a 1/3 chance of being included in the selection.
    // The '$' symbol means it has a 1/4 chance of being included in the selection.
    // (Why this @#$ thing? Otherwise, hard hands are overrepresented.)
    // 5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 <--- hard hands
    // 1  1  2  2  3  3  4  4  4  3  3  2  2  1  1  1 <--- hard hand frequency
    // 1  1  @  @  #  #  $  $  $  #  #  @  @  1  1  1 <--- symbol to use for baseline
    const situations = {
        '22': '4444674444',
        '23': '1111111111', // 5
        '24': '1111111111', // 6
        '25': '@@@@@@@@@@', // 7
        '26': '@@@11@@@@@', // 8
        '27': '33333#####', // 9
        '28': '@@@@@@@@@@', // 10
        '29': '@@@@@@@@@@', // 11
        '2X': '11@@@$$$$$', // 12
        '2A': '4455533333',
        '33': '4444674444',
        '34': '@@@@@@@@@@', // 7
        '35': '@@@11@@@@@', // 8
        '36': '33333#####', // 9
        '37': '@@@@@@@@@@', // 10
        '38': '@@@@@@@@@@', // 11
        '39': '11@@@$$$$$', // 12
        '3X': '##########', // 13
        '3A': '4455533333',
        '44': '5556666444',
        '45': '33333#####', // 9
        '46': '@@@@@@@@@@', // 10
        '47': '@@@@@@@@@@', // 11
        '48': '11@@@$$$$$', // 12
        '49': '##########', // 13
        '4X': '@@@@@@@@@@', // 14
        '4A': '3555533333',
        '55': '2222222222',
        '56': '@@@@@@@@@@', // 11
        '57': '11@@@$$$$$', // 12
        '58': '##########', // 13
        '59': '@@@@@@@@@@', // 14
        '5X': '#######111', // 15
        '5A': '3555333333',
        '66': '7777754444',
        '67': '##########', // 13
        '68': '@@@@@@@@@@', // 14
        '69': '#######111', // 15
        '6X': '@@@@@@@111', // 16
        '6A': '4444433333',
        '77': '4444794444',
        '78': '#######111', // 15
        '79': '@@@@@@@111', // 16
        '7X': '@@@@@@@@@2', // 17
        '7A': '5555555333',
        '88': '4444444446',
        '89': '@@@@@@@@@2', // 17
        '8X': '1111111111', // 18
        '8A': '3335933333',
        '99': '4444496655',
        '9X': '1111111111', // 19
        '9A': '2222222222',
        'XX': '1111111111', // 20
        'AA': '4477954444'
    };

    // global variables to hold score info.
    let numCorrect = 0;
    let numAlmostCorrect = 0;
    let numIncorrect = 0;
    let altActionRequested = false;
    let alt = null;
    let showAltRequested = false;

    // Returns an integer >= 0 and < max
    function getRandomInteger(max) {
        return Math.floor(Math.random() * max);
    }

    function getCardImageFilename(card) {
        const suite = suites[getRandomInteger(suites.length)];
        return 'cards/' + card + suite + '.png';
    }

    function convertActionCodeForNonHardMode(actionCode) {
        return actionCode[0] + ' ';
    }

    function sortHand(hand) {
        if (cardIndexes[hand[0]] > cardIndexes[hand[1]]) {
            return [hand[1], hand[0]];
        }
        return hand;
    }

    function standardizeCard(card) {
        switch (card) {
            case '10':
            case 'J':
            case 'Q':
            case 'K':
                return 'X';
        }
        return card;
    }

    function standardizeHand(hand) {
        return sortHand([standardizeCard(hand[0]), standardizeCard(hand[1])]);
    }

    function sumCardValues(hand) {
        const cardValueOfDeuce = 2;
        return cardIndexes[hand[0]] + cardValueOfDeuce + cardIndexes[hand[1]] + cardValueOfDeuce;
    }

    function getCellColorHtml(actionCode) {
        return ' background-color: ' + actionCodeColors[actionCode] + '; color: black;'
    }

    function mergeSegments(base, diff) {
        let newBase = '';
        for (let i = 0; i < numCharsInSegment; i++) {
            if (diff[i] === '.') {
                newBase += base[i];
            } else {
                newBase += diff[i];
            }
        }
        return newBase;
    }

    function getCorrectPlayRowSegment(correctPlayRow, currentOptions, isAlt) {
        const lookupKey = '' + currentOptions.decks
            + (currentOptions.isH17 ? 'H' : 'h')
            + (currentOptions.canSur ? 'U' : 'u')
            + (currentOptions.canDas ? 'D' : 'd')
            + (currentOptions.canDas ? 'a' : 'A');
        const segmentOffset = correctPlaySegmentOffsets[lookupKey];
        let finalSegment = correctPlayRow.substring(0, numCharsInSegment);
        if (segmentOffset === 0) {
            return finalSegment;
        }
        const specificSegment = correctPlayRow.substring(segmentOffset, segmentOffset + numCharsInSegment);
        return mergeSegments(finalSegment, specificSegment);
    }

    function convertCorrectPlayRowForDisplay(simplifiedHand, correctPlayRowSegment, isHardMode) {
        let result = '<tr><td>' + simplifiedHand + '</td>';
        for (let i = 0; i < numCharsInSegment; i += 2) {
            const actionCode = correctPlayRowSegment[i] + correctPlayRowSegment[i + 1];
            if (isHardMode) {
                result += '<td style="' + getCellColorHtml(actionCode) + '">' + actionCode + '</td>'
            } else {
                const nonHardModeActionCode = convertActionCodeForNonHardMode(actionCode);
                result += '<td style="' + getCellColorHtml(nonHardModeActionCode) + '">' + nonHardModeActionCode + '</td>'
            }
        }
        return result + '</tr>';
    }

    function isHandSplittable(hand) {
        return hand[0] === hand[1];
    }

    function isHandSoft(hand) {
        return hand[1] === 'A';
    }

    function displayCorrectPlays(currentOptions, showAlt) {
        let splitHandsSection = '';
        let softHandsSection = '';

        // Key is the sum of the card values in the hand. Value is the displayable row of correct plays.
        let hardHandsMap = new Map();

        let entries = Object.entries(correctPlays);
        if (currentOptions.reversed) {
            entries.reverse();
        }

        // Walk through the correct plays, and create displayable rows for the table to display.
        for (const [hand, correctPlayRow] of entries) {
            const correctPlayRowSegment = getCorrectPlayRowSegment(correctPlayRow, currentOptions, showAlt);
            if (isHandSplittable(hand)) {
                splitHandsSection += convertCorrectPlayRowForDisplay(hand, correctPlayRowSegment, currentOptions.isHardMode);
            } else {
                if (isHandSoft(hand)) {
                    softHandsSection += convertCorrectPlayRowForDisplay(hand, correctPlayRowSegment, currentOptions.isHardMode);
                } else {
                    let sum = sumCardValues(hand);
                    if (!hardHandsMap.has(sum)) {
                        hardHandsMap.set(sum, convertCorrectPlayRowForDisplay(sum, correctPlayRowSegment, currentOptions.isHardMode));
                    }
                }
            }
        }

        let hardHandsSection = '';
        const smallestHardHandSum = 5;
        const largestHardHandSum = 19;
        if (currentOptions.reversed) {
            for (let i = largestHardHandSum; i >= smallestHardHandSum; i--) {
                if (hardHandsMap.has(i)) {
                    hardHandsSection += hardHandsMap.get(i);
                }
            }
        } else {
            for (let i = smallestHardHandSum; i <= largestHardHandSum; i++) {
                if (hardHandsMap.has(i)) {
                    hardHandsSection += hardHandsMap.get(i);
                }
            }
        }

        const dealerCardHeader = '<td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td><td>10</td><td>A</td>';
        tableDiv.innerHTML = '<table border="1" id="PH"><tr><td>SPLIT HANDS</td>' + dealerCardHeader + '</tr>' + splitHandsSection
            + '<tr><td style="text-align: left;" id="SH">SOFT HANDS</td>' + dealerCardHeader + '</tr>' + softHandsSection
            + '<tdr><td style="text-align: left;" id="HH">HARD HANDS</td>' + dealerCardHeader + '</tr>' + hardHandsSection + '</table>';

        showTableKey(currentOptions);
    }

    function showTableKey(currentOptions) {
        const tableKey = Object.entries(actionNamesByActionCode);
        let table = '<table border="1">';
        for (let [actionCode, actionCodeMeaning] of tableKey) {
            const shouldShowEntry = (currentOptions.isHardMode && actionCodeIsForHardMode[actionCode])
                || (!currentOptions.isHardMode && actionCodeIsForNonHardMode[actionCode]);
            if (shouldShowEntry) {
                let isSurrender = actionCode[0] === 'U';
                if (!isSurrender || (isSurrender && currentOptions.canSur)) {
                    table += '<tr>'
                        + '<td style="text-align: left;' + getCellColorHtml(actionCode) + '">' + actionCode + '</td>'
                        + '<td style="text-align: left;">' + actionCodeMeaning + '</td>'
                        + '</tr>';
                }
            }
        }
        tableKeyDiv.innerHTML = table + '</table>';
    }

    function showScore() {
        const totalPlays = numCorrect + numAlmostCorrect + numIncorrect;
        let percentCorrect = 0;
        if (totalPlays > 0) {
            percentCorrect = Math.floor((numCorrect / totalPlays) * 100);
        }
        scoreDiv.innerHTML = 'SCORE: ' + percentCorrect + '%'
            + '<br>Correct plays: ' + numCorrect
            + '<br>Almost correct plays: ' + numAlmostCorrect
            + '<br>Incorrect plays: ' + numIncorrect;
    }

    function convertCardForDisplay(card) {
        if (card === 'X') {
            return cardsValuedTen[getRandomInteger(cardsValuedTen.length)];
        }
        return card;
    }

    function convertHandForDisplay(hand) {
        const randomlySwapOrder = 0 === getRandomInteger(2);
        if (randomlySwapOrder) {
            return [convertCardForDisplay(hand[0]), convertCardForDisplay(hand[1])];
        } else {
            return [convertCardForDisplay(hand[1]), convertCardForDisplay(hand[0])];
        }
    }

    function lookupFrequencyInHardMode(dealerCardFrequencyCode) {
        // The frequency is specified in the table, use the code or the value.
        switch (dealerCardFrequencyCode) {
            case '$':
                return getRandomInteger(4) === 0 ? 1 : 0;
            case '#':
                return getRandomInteger(3) === 0 ? 1 : 0;
            case '@':
                return getRandomInteger(2) === 0 ? 1 : 0;
            default:
                return dealerCardFrequencyCode;
        }
    }

    function computeFlatFrequency(situation) {
        // To achieve parity with random card generation, we must account for the four types of 10-value cards.
        let numTenValueCardsInSituation = 0;
        for (const card of situation) {
            numTenValueCardsInSituation += card === 'X' ? 1 : 0;
        }
        return numTenValueCardsInSituation === 0 ? 1 : numTenValueCardsInSituation * cardsValuedTen.length;
    }

    // A situation includes the two player cards and the dealer card.
    // This method generates every possible situation, duplicating ones that should be more frequently chosen,
    // and randomly selects one from the list.
    function selectSituation(isHardMode) {
        const situationsEntries = Object.entries(situations);
        const availableSituations = [];
        for (let [handCards, frequenciesByDealerCard] of situationsEntries) {
            for (let dealerCardIndex = 0; dealerCardIndex < frequenciesByDealerCard.length; dealerCardIndex++) {
                const situation = handCards + cards[dealerCardIndex];
                const numTimesToInclude = isHardMode
                    ? lookupFrequencyInHardMode(frequenciesByDealerCard[dealerCardIndex])
                    : computeFlatFrequency(situation);
                for (let i = 0; i < numTimesToInclude; i++) {
                    availableSituations.push(situation);
                }
            }
        }
        const chosenSituation = availableSituations[getRandomInteger(availableSituations.length)];
        return {
            hand: convertHandForDisplay(chosenSituation.substring(0, 2)),
            dealerCard: convertCardForDisplay(chosenSituation.substring(2, 3))
        }
    }

    // Randomly choose cards for the player and dealer, and display them.
    function deal(isHardMode) {
        const selectedSituation = selectSituation(isHardMode);

        dealerCardDiv.innerHTML = '<img src="' + getCardImageFilename(
            selectedSituation.dealerCard) + '" alt="' + selectedSituation.dealerCard + '" width="100">';
        dealerCardTextDiv.innerText = selectedSituation.dealerCard;
        playerCard1Div.innerHTML = '<img src="' + getCardImageFilename(
            selectedSituation.hand[0]) + '" alt="' + selectedSituation.hand[0] + '" width="100">';
        playerCard1TextDiv.innerText = selectedSituation.hand[0];
        playerCard2Div.innerHTML = '<img src="' + getCardImageFilename(
            selectedSituation.hand[1]) + '" alt="' + selectedSituation.hand[1] + '" width="100">';
        playerCard2TextDiv.innerText = selectedSituation.hand[1];
    }

    function getActionCodeFromCorrectPlays(correctPlayRow, dealerCard) {
        const i = cardIndexes[dealerCard] * charsPerActionCode;
        return correctPlayRow[i] + correctPlayRow[i + 1];
    }

    function lookupCorrectActionCode(dealerCard, hand, currentOptions, isAlt) {
        const correctPlayRow = correctPlays[hand[0] + hand[1]];
        const correctPlayRowSegment = getCorrectPlayRowSegment(correctPlayRow, currentOptions, isAlt);
        return getActionCodeFromCorrectPlays(correctPlayRowSegment, dealerCard);
    }

    function wasPlayAlmostCorrect(chosenActionCode, correctActionCode) {
        return chosenActionCode[0] === correctActionCode[0];
    }

    function wasPlayCorrect(chosenActionCode, correctActionCode, isHardMode) {
        if (!isHardMode) {
            return wasPlayAlmostCorrect(chosenActionCode, correctActionCode);
        }
        return chosenActionCode === correctActionCode;
    }

    function updatePlayResult(wasSuccess, wasFailure, wasClose, message) {
        if (!wasSuccess && !wasFailure && !wasClose) {
            resultPendingDiv.style.display = '';
            resultPendingDiv.innerText = 'Click a play button, and check here for the result.';
        } else {
            resultPendingDiv.style.display = 'none';
            resultPendingDiv.innerText = '';
        }
        resultSuccessDiv.innerText = wasSuccess ? message : '';
        resultSuccessDiv.style.display = wasSuccess ? '' : 'none';
        resultFailureDiv.innerText = wasFailure ? message : '';
        resultFailureDiv.style.display = wasFailure ? '' : 'none';
        resultCloseDiv.innerText = wasClose ? message : '';
        resultCloseDiv.style.display = wasClose ? '' : 'none';
    }

    function adjustResponse(word, altPlayWasCorrect) {
        return altPlayWasCorrect == null ? word : (altPlayWasCorrect ? word.toUpperCase() : word.toLowerCase());
    }

    function playWasCorrect(chosenAction, isHardMode, altWasCorrect) {
        numCorrect++;
        if (!isHardMode) {
            chosenAction = convertActionCodeForNonHardMode(chosenAction);
        }

        const message = adjustResponse('Correct! ', altWasCorrect) + playerCard1TextDiv.textContent
            + ' and ' + playerCard2TextDiv.textContent
            + ' versus ' + dealerCardTextDiv.textContent
            + ', you chose "' + actionNamesByActionCode[chosenAction] + '".';
        updatePlayResult(true, false, false, message);
    }

    function playWasAlmostCorrect(chosenAction, correctPlayCode, altWasCorrect) {
        numAlmostCorrect++;
        const message = adjustResponse('Almost right. ', altWasCorrect) + playerCard1TextDiv.textContent
            + ' and ' + playerCard2TextDiv.textContent
            + ' versus ' + dealerCardTextDiv.textContent
            + ', you chose "' + actionNamesByActionCode[chosenAction]
            + '", but the best play was "' + actionNamesByActionCode[correctPlayCode] + '".';
        updatePlayResult(false, false, true, message);
    }

    function playWasIncorrect(chosenAction, correctPlayCode, altWasCorrect) {
        numIncorrect++;
        const message = adjustResponse('Oops. ', altWasCorrect) + playerCard1TextDiv.textContent
            + ' and ' + playerCard2TextDiv.textContent
            + ' versus ' + dealerCardTextDiv.textContent
            + ', you chose "' + actionNamesByActionCode[chosenAction]
            + '", but the best play was "' + actionNamesByActionCode[correctPlayCode] + '".';
        updatePlayResult(false, true, false, message);
    }

    function getNumDecks(selectedValue) {
        switch (selectedValue) {
            case '1-deck':
                return 1;
            case '2-deck':
                return 2;
            case '4,6,8-deck':
                return 4;
        }
    }

    function getCurrentOptions() {
        return {
            decks: getNumDecks(decksSelect.value),
            isH17: soft17Select.value === 'H17',
            canSur: surrenderPermittedCheckbox.checked,
            canDas: dasPermittedCheckbox.checked,
            reversed: reverseTableCheckbox.checked,
            isHardMode: hardModeCheckbox.checked
        }
    }

    function updateButtons(currentOptions) {
        const showSurrenderButtons = currentOptions.canSur;
        const isHardMode = currentOptions.isHardMode;

        doubleButton.hidden = isHardMode;
        doubleHitButton.hidden = !isHardMode;
        doubleStandButton.hidden = !isHardMode;
        splitButton.hidden = isHardMode;
        splitHitButton.hidden = !isHardMode;
        splitStandButton.hidden = !isHardMode;
        splitDoubleHitButton.hidden = !isHardMode;

        if (isHardMode) {
            surrenderButton.hidden = true;
            surrenderHitButton.hidden = !showSurrenderButtons;
            surrenderStandButton.hidden = !showSurrenderButtons;
            surrenderSplitButton.hidden = !showSurrenderButtons;
        } else {
            surrenderButton.hidden = !showSurrenderButtons;
            surrenderHitButton.hidden = true;
            surrenderStandButton.hidden = true;
            surrenderSplitButton.hidden = true;
        }
    }

    function handleAction(action) {

        if (altActionRequested) {
            alt = action;
            altActionRequested = false;
            return;
        }

        const dealerCard = standardizeCard(dealerCardTextDiv.textContent);
        const hand = standardizeHand([playerCard1TextDiv.textContent, playerCard2TextDiv.textContent]);
        const isHardMode = hardModeCheckbox.checked;

        const currentOptions = getCurrentOptions();

        let altCorrectPlayCode = null;
        let altChosenAction = null;
        let altPlayWasCorrect = null;
        if (alt != null) {
            altCorrectPlayCode = lookupCorrectActionCode(dealerCard, hand, currentOptions, true);
            altChosenAction = actionCodesByAction[alt];
            altPlayWasCorrect = wasPlayCorrect(altChosenAction, altCorrectPlayCode, isHardMode);
        }

        const correctPlayCode = lookupCorrectActionCode(dealerCard, hand, currentOptions, false);
        const chosenAction = actionCodesByAction[action];
        if (wasPlayCorrect(chosenAction, correctPlayCode, isHardMode)) {
            playWasCorrect(chosenAction, isHardMode, altPlayWasCorrect);
        } else {
            if (wasPlayAlmostCorrect(chosenAction, correctPlayCode, altPlayWasCorrect)) {
                playWasAlmostCorrect(chosenAction, correctPlayCode);
            } else {
                playWasIncorrect(chosenAction, correctPlayCode, altPlayWasCorrect);
            }
        }

        showScore();
        displayCorrectPlays(currentOptions, false);
        updateButtons(currentOptions);
        deal(isHardMode);
        alt = null;
    }

    function handleOptionChanged(event) {
        switch (event.target.name) {
            case 'surrenderPermitted':
                if ((decksSelect.value === '1-deck' || decksSelect.value === '2-deck') && surrenderPermittedCheckbox.checked) {
                    surrenderPermittedCheckbox.checked = false;
                }
                break;
            case 'doubleAfterSplitPermitted':
                break;
            case 'hardMode':
                deal(hardModeCheckbox.checked);
                break;
            case 'reverseTable':
                break;
            case 'decks':
                if ((decksSelect.value === '1-deck' || decksSelect.value === '2-deck') && surrenderPermittedCheckbox.checked) {
                    surrenderPermittedCheckbox.checked = false;
                }
                break;
            case 'soft17':
                break;
        }
        const currentOptions = getCurrentOptions();
        updateButtons(currentOptions);
        displayCorrectPlays(currentOptions, false);
        altActionRequested = false;
        alt = null;
    }

    function initialSetup() {

        // Initialize the play result area
        updatePlayResult(false, false, false, '');

        // default options
        decksSelect.value = '4,6,8-deck';
        soft17Select.value = 'H17';
        surrenderPermittedCheckbox.checked = false;
        dasPermittedCheckbox.checked = true;
        hardModeCheckbox.checked = false;
        reverseTableCheckbox.checked = false;

        // button event handlers
        Object.keys(actionCodesByAction).forEach(action => {
            const button = document.getElementById(action);
            button.style.backgroundColor = actionCodeColors[actionCodesByAction[action]];
            button.addEventListener('click', () => handleAction(action));
        });

        // options event handlers
        decksSelect.addEventListener('change', handleOptionChanged);
        soft17Select.addEventListener('change', handleOptionChanged);
        surrenderPermittedCheckbox.addEventListener('change', handleOptionChanged);
        dasPermittedCheckbox.addEventListener('change', handleOptionChanged);
        hardModeCheckbox.addEventListener('change', handleOptionChanged);
        reverseTableCheckbox.addEventListener('change', handleOptionChanged);

        // alt action event handler
        dealerCardDiv.addEventListener('click', function () {
            altActionRequested = true;
        });
        document.getElementById('HH').addEventListener('click', function () {
            showAltRequested = !showAltRequested;
            displayCorrectPlays(getCurrentOptions(), showAltRequested);
        });
        const currentOptions = getCurrentOptions();

        showScore();
        displayCorrectPlays(currentOptions, false);
        updateButtons(currentOptions);
        deal(hardModeCheckbox.checked);
    }

    initialSetup();
});
